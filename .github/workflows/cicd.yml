name: Spring Boot CI/CD Pipeline

on:
  push:
    branches: ["main"]
    paths:
      - 'src/**'
      - 'pom.xml'
      - 'Dockerfile'
      - '.github/workflows/cicd.yml'

env:
  APP_NAME: "coffee-order-service"
  DOCKER_NETWORK: "springnet"

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: 🧹 Free up space
        run: |
          echo "Cleaning up system..."
          sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null
          docker system prune -af
          sudo pkill -9 java || true

      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ☕ Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ⚙️ Build with Maven
        run: |
          export MAVEN_OPTS="-Xms256m -Xmx512m -XX:+UseSerialGC"
          ./mvnw clean package -T 1C -DskipTests

      - name: 🐳 Build Docker image
        run: |
          docker build --no-cache \
            --memory=768m \
            -t $APP_NAME:${{ github.run_number }} \
            -t $APP_NAME:latest \
            .

      - name: 🚀 Deploy with Docker Compose
        run: |
          docker-compose down --remove-orphans || true
          docker network create $DOCKER_NETWORK || true
          docker-compose up -d --build

      - name: ✅ Verify health check
        timeout-minutes: 5
        run: |
          echo "Waiting for app to boot..."
          sleep 20
          curl -f http://localhost:8080/actuator/health
          curl -f http://localhost:8080/test || echo "Test endpoint not critical"

      - name: 🧾 Final system report
        if: always()
        run: |
          echo "Final disk/mem status:"
          free -h
          df -h
          docker system df
