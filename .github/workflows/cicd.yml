name: Optimized Build & Deploy

on:
  push:
    branches: ["main"]

env:
  MAVEN_OPTS: "-Dmaven.repo.local=/home/ubuntu/.m2/repository -Xms512m -Xmx768m" # Memory limits

jobs:
  build-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Cache Maven dependencies
      - name: Cache Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      # Build with cached deps
      - name: Build JAR
        run: |
          mvn clean package -DskipTests \
          -T 1C \                   # Limited to 1 thread
          -Dmaven.compiler.source=17 \
          -Dmaven.compiler.target=17

      # Smart Docker layer caching
      - name: Build Docker Image
        run: |
          docker build \
            --cache-from=${{ secrets.DOCKERHUB_USERNAME }}/coffee-order-service:latest \
            -t coffee-order-service:${{ github.run_number }} \
            -t coffee-order-service:latest \
            .

      # Efficient deployment
      - name: Deploy
        run: |
          docker-compose down --remove-orphans
          docker-compose up -d