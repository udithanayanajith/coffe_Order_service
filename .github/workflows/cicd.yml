name: Spring Boot CI/CD Pipeline

on:
  push:
    branches: ["main"]
    paths:
      - 'src/**'
      - 'pom.xml'
      - 'Dockerfile'
      - '.github/workflows/cicd.yml'

env:
  APP_NAME: "coffee-order-service"
  DOCKER_NETWORK: "springnet"

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Free resources
        run: |
          sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null
          docker system prune -f
          sudo pkill -9 java || true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Maven build
        run: |
          export MAVEN_OPTS="-Xms256m -Xmx512m -XX:+UseSerialGC"
          mvn clean package -T 1C -DskipTests -Dmaven.test.skip=true

      - name: Docker build
        run: |
          # Clean space aggressively
          sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches
          docker system prune -a -f
          
          # Build with minimal disk usage
          docker build \
            --no-cache \
            --memory 768m \
            -t $APP_NAME:${{ github.run_number }} \
            -t $APP_NAME:latest \
            .
          docker buildx prune -f

      - name: Deploy
        run: |
          docker-compose down --remove-orphans --timeout 30
          docker network create $DOCKER_NETWORK || true
          docker-compose up -d

      - name: Verify
        timeout-minutes: 5
        run: |
          sleep 20
          curl -sSf http://localhost/actuator/health | jq .
          curl -sSf http://localhost/test | jq .

      - name: System report
        if: always()
        run: |
          free -h
          df -h
          docker system df